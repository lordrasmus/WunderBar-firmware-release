
/** @file   led_control.c
 *  @brief  Contains definitions of functions for controling behaviour of sensor LED diode and corresponding macros, and global variables.
 *
 *  @author MikroElektronika
 *  @bug    No known bugs.
 */
 
/* -- Includes -- */

#include "led_control.h"
#include "app_timer.h"
#include "ble.h"
#include "gpio.h"
#include "ble_driver.h"

#define  LED_TIMEOUT_CONFIG_MS     500                               /**< LED blinking interval in ms for onboarding mode. */

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/**@brief  This record contain list possible states for LED diode. */
typedef enum
{
    LED_CONTROL_STATE_IDLE = 0,                                      /**< LED idle state. */
    LED_CONTROL_STATE_CHANGE_CHAR,                                   /**< Set LED trough corresponding characteristic. */
    LED_CONTROL_STATE_CONFIG                                         /**< LED is in config state, which is related to onboarding mode of sensor. */
}
led_control_state_t;
led_control_state_t led_control_state;

static app_timer_id_t led_control_timer_id;                          /**<  LED timer ID. */

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/**@brief  Declarations of private functions. */

static void led_control_tick_handler(void* context);
static bool led_control_timer_start(uint32_t interval);
static bool led_control_timer_stop(void);
static void led_control_toggle(void);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  Function creates timer for controling LED diode.
 *
 *  @return false in case error occurred, otherwise true.
 */
 
bool led_control_init(void)
{
    uint32_t err_code;
    
    err_code = app_timer_create(&led_control_timer_id, APP_TIMER_MODE_REPEATED, led_control_tick_handler);
    return (err_code == NRF_SUCCESS) ? true : false;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function update on/off state of LED diode base of coressponding characteristic.
 *
 *  @param  value       New state of diode.
 *  @param  timeout_ms  This param is valid in the case that the first param is TRUE. In that case it is "turn off timeout interval" in ms.
 *
 *  @return true if operation is successful, otherwise false.
 */

bool led_control_update_char(bool value, uint32_t timeout_ms)
{
	
	  // If diode are in LED_CONTROL_STATE_CONFIG state return from function.
    if(led_control_state == LED_CONTROL_STATE_CONFIG)
    {
        return false;
    }
    
		// Stop LED timer.
    if(!led_control_timer_stop())
		{			
				return false;
		}
  
		// If new value is false, just turn off LED. 
    if(value == false)
    {
        gpio_write(LED_PIN, false);
    }
		
		// Go to LED_CONTROL_STATE_CHANGE_CHAR, turn-on LED and start timer (waiting to turn off LED).
    else
    {
        led_control_state = LED_CONTROL_STATE_CHANGE_CHAR;
        gpio_write(LED_PIN, true);
        if(!led_control_timer_start(timeout_ms)) 
				{
						return false;
				}
    }
    
    return true;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function set config state, and start corresponding timer.
 *
 *  @return true if operation is successful, otherwise false.
 */

bool led_control_start_config(void)
{
    led_control_state = LED_CONTROL_STATE_CONFIG;
    return led_control_timer_start(LED_TIMEOUT_CONFIG_MS);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function handles timer timeout events.
 *
 *  @param  context  General purpose pointer.
 *
 *  @return Void.
 */

static void led_control_tick_handler(void* context) 
{  
    switch(led_control_state)
    {
			  // Timeout in LED_CONTROL_STATE_CHANGE_CHAR state. 
			  // It is necessary to stop the timer and turn off diode.
        case LED_CONTROL_STATE_CHANGE_CHAR:
        {
            led_control_timer_stop();
            gpio_write(LED_PIN, false);
            break;
        }
				
				// Timeout in LED_CONTROL_STATE_CONFIG state. 
			  // It is necessary to toggle diode.
        case LED_CONTROL_STATE_CONFIG:
        {
            led_control_toggle();
            break;
        }
        
        default: {}
    }
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  Toggle diode.
 *
 *  @return Void.
 */

static void led_control_toggle(void) 
{
    static bool on = false;
    on = !on;
    gpio_write(LED_PIN, on);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function starts LED timer.
 *
 *  @param  interval  Timeout interval in ms.
 *
 *  @return true if operation is successful, otherwise false.
 */

static bool led_control_timer_start(uint32_t interval) 
{  
    uint32_t err_code;
    err_code = app_timer_start(led_control_timer_id, APP_TIMER_TICKS(interval, 0), NULL);
    return (err_code == NRF_SUCCESS) ? true : false;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function stops LED timer.
 *
 *  @return true if operation is successful, otherwise false.
 */

static bool led_control_timer_stop(void) 
{  
    uint32_t err_code;
    led_control_state = LED_CONTROL_STATE_IDLE;
    err_code = app_timer_stop(led_control_timer_id);
    return (err_code == NRF_SUCCESS) ? true : false;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

