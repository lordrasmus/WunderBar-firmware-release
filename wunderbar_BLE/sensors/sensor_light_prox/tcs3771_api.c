

#include "tcs3771_api.h"
#include "nrf_delay.h"

// ---------------------------------------
// --- TCS3771-specific implementation ---
// ---------------------------------------

/** PRIVATE: generic read from TCS3771 register space, arbitrary length */
bool TCS3771_ReadRegisters(TWI_STRUCT* i2c, uint8_t addr, tcs3771_cmd_reg_t startReg, int len, uint8_t* buf);

/** PRIVATE: generic write to a TCS3771 8 bit register */
bool TCS3771_WriteRegister(TWI_STRUCT* i2c, uint8_t addr, tcs3771_cmd_reg_t reg, uint8_t value);

/** PRIVATE: generic 1 byte register read from TCS3771. Returns -1 on failure. */
int TCS3771_ReadRegister(TWI_STRUCT* i2c, uint8_t addr, tcs3771_cmd_reg_t reg);

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_ReadRegisters(TWI_STRUCT* i2c, uint8_t addr, tcs3771_cmd_reg_t startReg, int len, uint8_t* buf) 
{
    uint8_t cmd = 0xa0 | startReg;
    nrf_delay_us(2);  //TCS needs at least 1.3us between stop and start
    int written = i2c_write(i2c, addr, 1, &cmd, true);
    if (written != 1) 
    {
        return false;
    }

    nrf_delay_us(2);  //TCS needs at least 1.3us between stop and start
    
    int read = i2c_read(i2c, addr, len, buf);
    if (read != len) 
    {
        return false;
    }

    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_WriteRegister(TWI_STRUCT* i2c, uint8_t addr, tcs3771_cmd_reg_t reg, uint8_t value) 
{
    uint8_t buf[] = {0xa0 | reg, value};
    nrf_delay_us(2);  //TCS needs at least 1.3us between stop and start
    int written = i2c_write(i2c, addr, 2, buf, true);
    return (written == 2);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int TCS3771_ReadRegister(TWI_STRUCT* i2c, uint8_t addr, tcs3771_cmd_reg_t reg) 
{
    uint8_t buf = 0;
    if (!TCS3771_ReadRegisters(i2c, addr, reg, 1, &buf)) 
    {
        return -1;
    }
    return buf;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_PowerOn(TWI_STRUCT* i2c, uint8_t addr) 
{
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_ENABLE, TCS3771_ENABLE_PON)) 
    {
        return false;
    }
    
    volatile uint32_t i = 0;  //TODO: Should refactor delay to some more useful space
    while (i < 100000) { i++; }
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_PowerOff(TWI_STRUCT* i2c, uint8_t addr) 
{
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_ENABLE, 0)) 
    {
        return false;
    }
    
    volatile uint32_t i = 0;  //TODO: Should refactor delay to some more useful space
    while (i < 100000) { i++; }
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int TCS3771_GetId(TWI_STRUCT* i2c, uint8_t addr) 
{
    return TCS3771_ReadRegister(i2c, addr, TCS3771_CMD_REG_ID);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

int TCS3771_GetStatus(TWI_STRUCT* i2c, uint8_t addr) 
{
    return TCS3771_ReadRegister(i2c, addr, TCS3771_CMD_REG_STATUS);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetColorSensParams(TWI_STRUCT* i2c, uint8_t addr, uint8_t integ_cycles) 
{   
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_ATIME, (256 - integ_cycles)))
    {     
        return false;
    }
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetWaitTime(TWI_STRUCT* i2c, uint8_t addr, uint8_t time, bool x12) 
{
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_WTIME, (256 - time))) 
    {
        return false;
    }
    
    return TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_CONFIG, x12 ? TCS3771_CONFIG_WAIT_LONG : TCS3771_CONFIG_WAIT_SHORT);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetProximityParams(TWI_STRUCT* i2c, uint8_t addr, uint8_t integ_cycles, uint8_t pulsecount) 
{   
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PTIME, (256 - integ_cycles))) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PPCOUNT, pulsecount)) 
    {
        return false;
    }
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetControlRegister(TWI_STRUCT* i2c, uint8_t addr, sensor_lightprox_prox_drive_t pulsestrength, sensor_lightprox_rgbc_gain_t gain)
{
    int ctl;
    tcs3771_ctl_pdiode_t sensor = TCS3771_CTL_PDIODE_RED;
    
    ctl = TCS3771_ReadRegister(i2c, addr, TCS3771_CMD_REG_CONTROL);
    
    if (ctl < 0)
    {     
        return false;
    }
    
    ctl = pulsestrength | sensor | gain;
  
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_CONTROL, ctl)) 
    {
        return false;
    }
    
    return true;    
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetControlParams(TWI_STRUCT* i2c, uint8_t addr,
                              uint8_t rgbc_time, 
                              tcs3771_ctl_again_t rgbc_gain,
                              uint8_t prox_time, 
                              uint8_t prox_pulses, 
                              tcs3771_ctl_pdrive_t prox_drive, 
                              tcs3771_ctl_pdiode_t prox_channel,
                              uint8_t wait_time, bool wait_long) 
{
    uint8_t ctl;
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_ATIME, ~rgbc_time)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PTIME, ~prox_time)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PPCOUNT, prox_pulses)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_WTIME, ~wait_time)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_CONFIG, wait_long ? TCS3771_CONFIG_WAIT_LONG : TCS3771_CONFIG_WAIT_SHORT)) 
    {
        return false;
    }
    
    ctl = (rgbc_gain & TCS3771_CTL_AGAIN_MASK) | (prox_drive & TCS3771_CTL_PDRIVE_MASK) | (prox_channel & TCS3771_CTL_PDIODE_MASK);
    
    return TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_CONTROL, ctl);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetMode(TWI_STRUCT* i2c, uint8_t addr, bool en_rgbc, bool en_prox, bool en_wait, bool en_bright_int, bool en_prox_int) 
{
    uint8_t en = TCS3771_ENABLE_PON 
                | (en_rgbc ? TCS3771_ENABLE_AEN : 0)
                | (en_prox ? TCS3771_ENABLE_PEN : 0)  
                | (en_wait ? TCS3771_ENABLE_WEN : 0)  
                | (en_bright_int ? TCS3771_ENABLE_AIEN : 0) 
                | (en_prox_int ? TCS3771_ENABLE_PIEN : 0);
  
    return TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_ENABLE, en);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_GetValues(TWI_STRUCT* i2c, uint8_t addr, uint16_t* c, uint16_t* r, uint16_t* g, uint16_t* b, uint16_t* p) 
{
    int status = TCS3771_GetStatus(i2c, addr);
  
    if (status < 0) 
    {
        return false;
    }

    //TODO: Find a way to return that no comm error occurred but samples are not valid. 
    //For now, old cvalues are read *********
    if (!(status & 0x1)) 
    {
        return false; //comm error or no valid sample
    }

    if (c && r && g && b && p) 
    {   //single read for all values
        uint8_t val[10] = {0,0,0,0,0,0,0,0,0,0};
        if (!TCS3771_ReadRegisters(i2c, addr, TCS3771_CMD_REG_CDATA, 10, val)) 
        {
            return false;
        }
        
        *c = val[1]<<8 | val[0];
        *r = val[3]<<8 | val[2];
        *g = val[5]<<8 | val[4];
        *b = val[7]<<8 | val[6];
        *p = val[9]<<8 | val[8];
    } 
    else 
    {
        uint8_t val[2] = {0,0};
        
        if (c) 
        {
            if (!TCS3771_ReadRegisters(i2c, addr, TCS3771_CMD_REG_CDATA, 2, val)) return false;
            *c = val[1]<<8 | val[0];
        }
        if (r) 
        {
            if (!TCS3771_ReadRegisters(i2c, addr, TCS3771_CMD_REG_RDATA, 2, val)) return false;
            *r = val[1]<<8 | val[0];
        }
        if (g) 
        {
            if (!TCS3771_ReadRegisters(i2c, addr, TCS3771_CMD_REG_GDATA, 2, val)) return false;
            *g = val[1]<<8 | val[0];
        }
        if (b) 
        {
            if (!TCS3771_ReadRegisters(i2c, addr, TCS3771_CMD_REG_BDATA, 2, val)) return false;
            *b = val[1]<<8 | val[0];
        }
        if (p) 
        {
            if (!TCS3771_ReadRegisters(i2c, addr, TCS3771_CMD_REG_PDATA, 2, val)) return false;
            *p = val[1]<<8 | val[0];
        }
    }
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetBrightnessWindow(TWI_STRUCT* i2c, uint8_t addr, uint16_t lower, uint16_t upper, tcs3771_pers_bright_t persistence) 
{
    int val;
    
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_AILTL, lower & 0xff)) 
    {
        return false;
    }
      
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_AILTH, (lower >> 8) & 0xff)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_AIHTL, upper & 0xff)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_AIHTH, (upper >> 8) & 0xff)) 
    {
        return false;
    }
    
    val = TCS3771_ReadRegister(i2c, addr, TCS3771_CMD_REG_PERS);
    
    if (val < 0) 
    { 
        return false;
    }
    
    val = (val & TCS3771_PERS_PROX_MASK) | persistence;
    
    if(!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PERS, val))
    {
        return false;
    }
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_SetProximityWindow(TWI_STRUCT* i2c, uint8_t addr, uint16_t lower, uint16_t upper, tcs3771_pers_prox_t persistence) 
{
    int val;
      
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PILTL, lower & 0xff)) 
    {
        return false;
    }

    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PILTH, (lower >> 8) & 0xff)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PIHTL, upper & 0xff)) 
    {
        return false;
    }
    
    if (!TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PIHTH, (upper >> 8) & 0xff)) 
    {
        return false;
    }
    
    val = TCS3771_ReadRegister(i2c, addr, TCS3771_CMD_REG_PERS);
    
    if (val < 0) 
    {
        return false;
    }
    
    val = (val & TCS3771_PERS_BRIGHT_MASK) | persistence;
    
    return TCS3771_WriteRegister(i2c, addr, TCS3771_CMD_REG_PERS, val);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool TCS3771_ClearInterrupts(TWI_STRUCT* i2c, uint8_t addr, bool clear_rgbc, bool clear_prox) 
{
    uint8_t val;
    int written;
  
    if ((!clear_rgbc) && (!clear_prox)) 
    {
        return true; //nothing to do
    }
    
    val = 0xe4 | (clear_rgbc ? 2 : 0) | (clear_prox ? 1 : 0);
    
    nrf_delay_us(2);  //TCS needs at least 1.3us between stop and start
    written = i2c_write(i2c, addr, 1, &val, true);
    
    return (written == 1);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
