
/** @file   mpu6500.c
 *  @brief  This driver contains definitions of functions for working with MPU6500 sensor 
 *          and corresponding macros, constants,and global variables.
 *
 *  @author MikroElektronika
 *  @bug    No known bugs.
 */
 
/* -- Includes -- */

#include "mpu6500.h"
#include "nrf_delay.h"

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/**@brief Declaration of static variables. */
static int16_t mpu6500_gyro_range;
static int16_t mpu6500_acc_range;
static int16_t data_adc[3];

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function is called to initialize i2c interface to MPU6500 sensor.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *  @param  i2c  Pointer to an record that relates to the Two-Wire module.
 *
 *  @return  false in case that error is occurred, otherwise true.
 */
 
bool mpu6500_init(mpup6500_struct_t * mpu, TWI_STRUCT * i2c) 
{
    uint8_t reg_data[2];
  
	  // Startup delay.
    nrf_delay_us(MPU6500_STARTUP_TIME);
	  
	  // Init I2C module with corresponding pins and speed.
    if (!i2c_init(i2c, MPU6500_I2C_SCL_PIN, MPU6500_I2C_SDA_PIN, K400)) 
    {
        return false;
    }
    mpu->i2c = i2c;
    
    // Reset device.
    reg_data[0] = MPU6500_PWR_MGMT_1;
    reg_data[1] = 0x80;
    int i = i2c_write(mpu->i2c, MPU6500_I2C_ADDR, 2, reg_data, true);
    if (i != 2) 
    {
        return false;
    } 
    
    // Wait to clear reset bit.
    while(reg_data[1] & 0x80)
    {
        i2c_write_read(mpu->i2c, MPU6500_I2C_ADDR, 1, &reg_data[0], 1, &reg_data[1]);
    }
    
    // Set logic level for INT pin to active low
    reg_data[0] = MPU6500_INT_PIN_CFG;
    reg_data[1] = 0x80;
    i = i2c_write(mpu->i2c, MPU6500_I2C_ADDR, 2, reg_data, true);
    if (i != 2)
    {
        return false;
    } 
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function reads WHO_AM_I register. This register is used to verify the identity of the device. The contents of WHO_AM_I is an 8-bit device ID.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *  @param  i2c  Pointer to an record that relates to the Two-Wire module.
 *
 *  @return  false in case that error is occurred, otherwise true.
 */

bool mpu6500_who_am_i(mpup6500_struct_t * mpu, uint8_t * data) 
{
    return mpu6500_read_register(mpu, MPU6500_WHO_AM_I_REG, data);
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function retrieves the contents of MPU6500 sensor internal register.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *  @param  i2c  Pointer to an record that relates to the Two-Wire module.
 *  @param  reg  MPU6500 sensor internal register address.
 *  @param  data Provided storage used to hold the register value. 
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_read_register(mpup6500_struct_t * mpu, uint8_t reg, uint8_t * data) 
{
    int i = i2c_write_read(mpu->i2c, MPU6500_I2C_ADDR, 1, &reg, 1, data);
    if (i != 2) 
    {
        return false;
    } 
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function retrieves bytes of measured coordinates.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *  @param  reg  MPU6500 sensor internal "measured coordinates" register address (MPU6500_ACCEL_XOUT_H/MPU6500_GYRO_XOUT_H).
 *  @param  data Provided storage used to hold the measured data. 
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_get_data(mpup6500_struct_t * mpu, uint8_t reg, uint8_t * data)
{
    uint8_t reg_data[6];
    int i = i2c_write_read(mpu->i2c, MPU6500_I2C_ADDR, 1, &reg, 6, reg_data);
    if (i != 7) 
    {
        return false;
    } 
    
    data[0] = reg_data[1];
    data[1] = reg_data[0];
    
    data[2] = reg_data[3];
    data[3] = reg_data[2];
    
    data[4] = reg_data[5];
    data[5] = reg_data[4];
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function retrieves accelerometer measured coordinates.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *  @param  data Provided storage used to hold the measured data. 
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_get_acc(mpup6500_struct_t * mpu, coord_float_t * data)
{
    
    if(!mpu6500_get_data(mpu, MPU6500_ACCEL_XOUT_H, (uint8_t *)data_adc))
    {
        return false;
    }
    
    data->x = ((float)mpu6500_acc_range * data_adc[0]) / 65535;
    data->y = ((float)mpu6500_acc_range * data_adc[1]) / 65535;
    data->z = ((float)mpu6500_acc_range * data_adc[2]) / 65535;
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function retrieves gyroscope measured coordinates.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *  @param  data Provided storage used to hold the measured data. 
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_get_gyro(mpup6500_struct_t * mpu, coord_float_t * data)
{
    int16_t data_adc[3];
    if(!mpu6500_get_data(mpu, MPU6500_GYRO_XOUT_H, (uint8_t *)data_adc))
    {
        return false;
    }
    
    data->x = ((float)mpu6500_gyro_range * data_adc[0]) / 65535;
    data->y = ((float)mpu6500_gyro_range * data_adc[1]) / 65535;
    data->z = ((float)mpu6500_gyro_range * data_adc[2]) / 65535;
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function configures full scale modes for accelerometer and gyroscope.
 *
 *  @param  mpu    Pointer to an record that relates to the MPU6500 sensor.
 *  @param  config Pointer to an sensor config record.
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_config(mpup6500_struct_t * mpu, sensor_gyro_config_t * config)
{
    uint8_t reg_data[2], tmp;
    
    ////////////////////////////////////
    // Gyro full scale select
  
    reg_data[0] =  MPU6500_GYRO_CONFIG;
    int i = i2c_write_read(mpu->i2c, MPU6500_I2C_ADDR, 1, &reg_data[0], 1, &reg_data[1]);
    if (i != 2) 
    {
        return false;
    } 
    tmp = *((uint8_t*)&config->gyro_full_scale);
    reg_data[1] &=  0x18;
    reg_data[1] |= (tmp << 3);
    i = i2c_write(mpu->i2c, MPU6500_I2C_ADDR, 2, reg_data, true);
    if (i != 2) 
    {
        return false;
    } 
    
    mpu6500_gyro_range = ((uint16_t)config->gyro_full_scale + 1) * 500;
      
    
    ////////////////////////////////////
    // Acc full scale select
    
    reg_data[0] =  MPU6500_ACCEL_CONFIG;
    i = i2c_write_read(mpu->i2c, MPU6500_I2C_ADDR, 1, &reg_data[0], 1, &reg_data[1]);
    if (i != 2) 
    {
        return false;
    } 
    tmp = *((uint8_t*)&config->acc_full_scale);
    reg_data[1] &=  0x18;
    reg_data[1] |= (tmp << 3);
    i = i2c_write(mpu->i2c, MPU6500_I2C_ADDR, 2, reg_data, true);
    if (i != 2) 
    {
        return false;
    } 
    
    mpu6500_acc_range = (uint16_t)1 << ((uint8_t)config->acc_full_scale + 2);
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function sends sensor to sleep mode.
 *
 *  @param  mpu  Pointer to an record that relates to the MPU6500 sensor.
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_sleep(mpup6500_struct_t * mpu)
{
    uint8_t reg_data[2];
  
    reg_data[0] = MPU6500_PWR_MGMT_1;
    reg_data[1] = 0x49;
  
    int i = i2c_write(mpu->i2c, MPU6500_I2C_ADDR, 2, reg_data, true);
    if (i != 2) 
    {
        return false;
    } 
    
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/** @brief  This function wakes up sensor.
 *
 *  @param  mpu Pointer to an record that relates to the MPU6500 sensor.
 *
 *  @return false in case that error is occurred, otherwise true.
 */

bool mpu6500_wakeup(mpup6500_struct_t * mpu)
{
    uint8_t reg_data[2];
  
    reg_data[0] = MPU6500_PWR_MGMT_1;
    reg_data[1] = 0x9;
  
    int i = i2c_write(mpu->i2c, MPU6500_I2C_ADDR, 2, reg_data, true);
    if (i != 2) 
    {
        return false;
    } 
    return true;
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
